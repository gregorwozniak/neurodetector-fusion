<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
  <title>NeuroDetector ¬∑ Simplex+ FUSION v7.1.3 ‚Äî NO GPS</title>
  <meta name="theme-color" content="#1a3a1a"/>
  <meta name="description" content="AI-Powered Metal Detector Signal Analyzer ‚Äî offline, real-time FFT, target classification">
  
  <!-- ‚úÖ PWA ESSENTIALS -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/icon-192.png">
  
  <!-- iOS support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NeuroDetector">

  <style>
    /* ‚Äî‚Äî‚Äî Twoje oryginalne style ‚Äî bez zmian ‚Äî */
    :root{
      --radio-bg:#1a2b1a; --dial-bg:#2c4a2c; --highlight:#50c878; --text:#e0ffe0; --border:#4a7a4a;
      --warning:#ffd93d; --danger:#ff6b6b; --ai-blue:#4da6ff; --train-purple:#b35cff; --panel-bg:rgba(50,50,80,.2);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Courier New',monospace; background:linear-gradient(135deg,#0d1b0d,#1a3a1a);
      color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:8px;
    }
    .card{
      width:100%; max-width:100%; background:var(--radio-bg); border:2px solid var(--border);
      border-radius:10px; padding:14px; margin-bottom:12px; box-shadow:0 0 16px rgba(0,0,0,.6), inset 0 0 12px rgba(0,0,0,.4);
    }
    .brand{font-size:1.6rem; text-align:center; color:var(--highlight); font-weight:700; text-shadow:0 0 6px rgba(80,200,120,.7); margin-bottom:2px}
    .subtitle{text-align:center; font-size:0.8rem; color:#a9caa9}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .block{background:var(--dial-bg); border:1px solid var(--border); border-radius:8px; padding:10px}
    .label{display:block; color:var(--highlight); font-weight:700; font-size:0.95rem; margin-bottom:4px}
    .value{background:rgba(0,0,0,.25); border-radius:6px; padding:6px; font-weight:700; text-align:center}
    .value .live{color:var(--warning); font-size:1.5rem}
    .btn-row{display:flex; gap:6px; margin-top:10px; flex-wrap:wrap; justify-content:space-between}
    .btn{
      padding:11px 8px; background:#334d33; border:1px solid var(--border); border-radius:8px;
      color:var(--text); font-weight:700; cursor:pointer;
      flex:1; min-width:110px; text-align:center; transition: all 0.15s;
      font-size:0.9rem;
    }
    .btn:hover:not(:disabled){background:#446644; transform: scale(1.02);}
    .btn:active:not(:disabled){transform: scale(0.98);}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn-start{background:#1d5c1d}
    .btn-stop{background:#9d0208}
    .btn-save{background:#3a3a8b}
    .btn-ghost{background:transparent; border-color:#5a5a8a}
    .btn-export{background:#8b3a8b}
    .btn-danger{background:#78290f}
    .btn-tts{background:#ffa500; color:#000}
    .btn-hud{background:#003366; color:#fff}
    .panel{background:var(--panel-bg); border:1px solid #5a5a8a; border-radius:8px; padding:10px}
    .spectrum{width:100%; height:80px; background:#000; border-radius:6px; margin:6px 0}
    .pulse{animation:pulse 1.6s infinite}
    @keyframes pulse{0%{opacity:1} 50%{opacity:.6} 100%{opacity:1}}
    .list{display:flex; flex-direction:column; gap:6px}
    .item{display:flex; justify-content:space-between; gap:6px; background:rgba(0,0,0,.2); padding:8px; border-radius:6px; font-size:0.88rem}
    .item.selected{background:rgba(80,200,120,0.15); border:1px solid var(--highlight);}
    .item-actions{display:flex; gap:4px}
    .hint{font-size:0.82rem; color:#ffd93d}
    .small{font-size:0.88rem}
    .center{text-align:center}
    .hidden{display:none}
    .confidence-meter {
      width:100%; height:7px; background:#333; border-radius:4px; margin:6px 0; overflow:hidden;
    }
    .confidence-bar {
      height:100%; background:linear-gradient(90deg, #ff4500, #ffd700, #32cd32); border-radius:4px; width:0%; transition: width 0.3s;
    }
    .ai-high-confidence { animation: glow 2s infinite; }
    @keyframes glow { 0%{box-shadow:0 0 5px #ff0} 50%{box-shadow:0 0 16px #ff0} 100%{box-shadow:0 0 5px #ff0} }
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.92); display:none; align-items:center; justify-content:center; z-index:1000; padding:12px}
    .modal{
      background:var(--radio-bg); border:2px solid var(--border); border-radius:10px;
      padding:14px; width:100%; max-width:100%; max-height:90vh; overflow-y:auto;
    }
    .close-fab{
      position:absolute; top:12px; right:12px; background:var(--danger); border:1px solid #a33;
      border-radius:8px; padding:8px; color:#fff; cursor:pointer; width:34px; height:34px;
      display:flex; align-items:center; justify-content:center; font-size:14px;
      font-weight:bold;
    }
    input, select, textarea{
      width:100%; padding:10px; background:var(--dial-bg); color:var(--text);
      border:1px solid var(--border); border-radius:6px;
      font-family:'Courier New',monospace; font-size:1rem;
    }
    .tag-row .btn{flex:initial; min-width:auto; padding:6px 10px; font-size:0.85rem}
    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      background:#1f2937; color:#fff; border:1px solid #374151;
      border-radius:8px; padding:10px 14px; display:none; z-index:2000;
      box-shadow:0 4px 16px rgba(0,0,0,.35), 0 0 0 2px rgba(80,200,120,0.2);
      font-size:1rem;
    }
    @media (max-width:420px) {
      body { padding: 6px; }
      .card { padding: 12px 10px; }
      .brand { font-size:1.4rem; }
      .subtitle { font-size:0.75rem; }
      .row { gap:6px; }
      .block { padding:8px; }
      .label { font-size:0.88rem; margin-bottom:3px; }
      .value { padding:5px 4px; font-size:0.95rem; }
      .value .live { font-size:1.45rem; }
      .btn { padding:12px 6px; min-width:100%; font-size: 0.88rem; }
      .spectrum { height:70px; }
      input, select { padding:9px 8px; font-size:0.95rem; }
      .modal { padding:12px; }
    }
  </style>
</head>
<body>

  <!-- üîç UWAGA: usuniƒôto <img src="img/wyszukiwacz.png"> z <head> ‚Äî tu mo≈ºesz go dodaƒá, je≈õli potrzebny -->
  <!-- Przyk≈Çad: -->
  <!-- <img src="img/wyszukiwacz.png" alt="Wykrywacz metali" style="display:none"> -->

  <div class="card">
    <div class="brand">NEURO DETECTOR ¬∑ FUSION v7.1.3</div>
    <div class="subtitle">Simplex+ ¬∑ LIVE AI + TTS ‚Äî NO GPS</div>
    <div class="row" style="margin-top:10px">
      <div class="block" style="flex:1">
        <span class="label">STATUS</span>
        <div id="status" class="value center">Oczekiwanie na mikrofon...</div>
      </div>
      <div class="block" style="flex:1">
        <span class="label">≈πR√ìD≈ÅO MIKROFONU</span>
        <select id="micSelect"><option value="">Domy≈õlny</option></select>
      </div>
    </div>
    <div class="block">
      <span class="label">CZU≈ÅO≈öƒÜ / PR√ìG</span>
      <div class="row">
        <input id="sensitivity" type="range" min="0" max="20" step="1" value="6" style="flex:1">
        <div class="small" style="min-width:140px; text-align:right">
          Margines: <b><span id="marginVal">6</span> dB</b><br>
          T≈Ço: <b><span id="noiseVal">--</span> dB</b> ¬∑ Pr√≥g: <b><span id="thVal">--</span> dB</b>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="block" style="flex:1">
        <span class="label">TON [Hz] ‚Äî LIVE</span>
        <div class="value"><span id="freqValue" class="live">---</span> Hz</div>
        <div id="calibBadge" class="hint center" style="display:none; margin-top:6px"></div>
      </div>
      <div class="block" style="flex:1">
        <span class="label">G≈ÅO≈öNO≈öƒÜ [dB]</span>
        <div class="value"><span id="volValue" class="live">---</span> dB</div>
      </div>
      <div class="block" style="flex:1">
        <span class="label">CZAS SYGNA≈ÅU</span>
        <div class="value"><span id="timeValue" class="live">---</span> s</div>
      </div>
    </div>
    <canvas id="spectrumCanvas" class="spectrum"></canvas>
    <div id="aiMsg" class="panel center">üëÇ Czekam na sygna≈Ç z detektora...</div>
    <div class="confidence-meter"><div id="confidenceBar" class="confidence-bar"></div></div>
    <div class="btn-row">
      <button id="startBtn" class="btn btn-start">‚ñ∂ START MIC</button>
      <button id="stopBtn" class="btn btn-stop" disabled>‚èπ STOP</button>
      <button id="saveBtn" class="btn btn-save" disabled>üíæ ZAPISZ</button>
      <button id="openCalib" class="btn">‚öôÔ∏è KALIBR</button>
    </div>
    <div class="btn-row">
      <button id="trainBtn" class="btn">üéì TRENING</button>
      <button id="recordBtn" class="btn">üé§ NAGRAJ</button>
      <button id="exportBtn" class="btn btn-export">üì§ CSV</button>
      <button id="mapBtn" class="btn btn-ghost" disabled>üó∫Ô∏è MAPA (wy≈Ç.)</button>
    </div>
    <div class="btn-row">
      <button id="ttsToggle" class="btn btn-tts">üîà TTS: W≈Å</button>
      <button id="autoSaveToggle" class="btn btn-ghost">üíæ AutoSave: WY≈Å</button>
      <button id="hudToggle" class="btn btn-hud">‚õ∂ HUD: WY≈Å</button>
      <button id="cloudBtn" class="btn btn-ghost">‚òÅÔ∏è BACKUP</button>
    </div>
  </div>
  <div id="detCard" class="card" style="display:none">
    <h3 class="center">üóÇÔ∏è WYKRYCIA</h3>
    <div class="row" style="margin:10px 0">
      <input id="searchInput" placeholder="üîé Wyszukaj po opisie...">
    </div>
    <div id="detList" class="list"></div>
  </div>
  <div id="saveOverlay" class="overlay">
    <div class="modal">
      <button class="close-fab" id="cancelSave">X</button>
      <h3 class="center">Zapisz znalezisko</h3>
      <input id="noteInput" placeholder="Opisz znalezisko...">
      <div class="row tag-row" style="margin:8px 0">
        <button class="btn" data-tag="[Moneta] ">Moneta</button>
        <button class="btn" data-tag="[Militaria] ">Militaria</button>
        <button class="btn" data-tag="[Srebro] ">Srebro</button>
        <button class="btn" data-tag="[≈ömieƒá] ">≈ömieƒá</button>
      </div>
      <div class="btn-row">
        <button id="confirmSave" class="btn btn-save">‚úÖ ZAPISZ</button>
        <button id="discardBtn" class="btn btn-danger">‚ùå ODRZUƒÜ</button>
      </div>
    </div>
  </div>
  <div id="calibOverlay" class="overlay">
    <div class="modal">
      <button class="close-fab" id="closeCalib">X</button>
      <h3 class="center">üîß Kalibracja czƒôstotliwo≈õci</h3>
      <div class="row" style="margin:8px 0">
        <button id="calibMicBtn" class="btn btn-tts" style="flex:1">üé§ MIC KALIBRACJI: WY≈Å</button>
      </div>
      <div class="block" style="margin-top:8px">
        <span class="label">Sygna≈Ç referencyjny</span>
        <select id="calibRef">
          <option value="2450">Z≈Çoto/Srebro (2450 Hz)</option>
          <option value="2800">Srebro (2800 Hz)</option>
          <option value="850">Folia (850 Hz)</option>
          <option value="420">≈ªelazo (420 Hz)</option>
        </select>
      </div>
      <div class="row" style="gap:6px; margin-top:8px">
        <div class="block" style="flex:1">
          <span class="label">Zakres [¬±Hz]</span>
          <input id="freqRange" type="number" min="1" max="200" value="10" style="text-align:center">
        </div>
        <div class="block" style="flex:1">
          <span class="label">Min. czas [s]</span>
          <input id="minDur" type="number" step="0.01" min="0.01" max="5" value="0.02" style="text-align:center">
        </div>
        <div class="block" style="flex:1">
          <span class="label">Max. czas [s]</span>
          <input id="maxDur" type="number" step="0.01" min="0.05" max="10" value="0.80" style="text-align:center">
        </div>
      </div>
      <div class="row">
        <div class="block" style="flex:1">
          <span class="label">TON LIVE</span>
          <div class="value center"><span id="liveCalib" class="live">---</span> Hz</div>
        </div>
        <div class="block" style="flex:1">
          <span class="label">PR√ìBKI</span>
          <div id="sampleCount" class="value center">0 / 5</div>
        </div>
      </div>
      <div id="calibMsg" class="panel center small">üéôÔ∏è Czekam na sygna≈Ç... (utrzymaj ~0.5‚Äì1.5 s)</div>
      <div class="btn-row">
        <button id="autoBtn" class="btn btn-start">‚ñ∂ AUTO PR√ìBKA</button>
        <button id="grabBtn" class="btn">‚ûï Z≈ÅAP PR√ìBKƒò</button>
        <button id="quickBtn" class="btn">‚ö° SZYBKA KALIBRACJA</button>
      </div>
      <div class="btn-row">
        <button id="applyBtn" class="btn btn-save">‚úÖ ZASTOSUJ (‚â•3)</button>
        <button id="clearSamplesBtn" class="btn btn-ghost">üóëÔ∏è WYCZY≈öƒÜ WSZYSTKIE</button>
      </div>
      <div id="samplesCard" class="panel" style="display:none; margin-top:8px">
        <div id="samplesList" class="list"></div>
      </div>
      <div class="panel" style="margin-top:10px">
        <span class="label">üíæ Trwa≈Çe wzorce metali</span>
        <div class="row" style="margin-top:6px; gap:4px">
          <input id="sampleNameInput" type="text" placeholder="Nazwa (np. ≈ªelazo_2)">
          <input id="sampleTypeInput" type="text" placeholder="Typ (np. üî© ≈ªELAZO)" style="flex:1.5">
          <button id="saveSampleBtn" class="btn btn-save" style="min-width:auto;padding:6px 10px">üíæ ZAPISZ</button>
        </div>
        <div id="savedSamplesList" class="list" style="margin-top:8px; max-height:140px; overflow-y:auto"></div>
        <div class="btn-row" style="margin-top:6px">
          <button id="editSampleBtn" class="btn btn-ghost" disabled>‚úèÔ∏è Edytuj</button>
          <button id="useSampleAsRef" class="btn btn-ghost" disabled>‚û°Ô∏è Referencja</button>
          <button id="deleteSampleBtn" class="btn btn-danger" disabled>üóëÔ∏è Usu≈Ñ</button>
        </div>
      </div>
      <div class="panel" style="margin-top:10px">
        <span class="label">Offset rƒôczny</span>
        <input id="manualOffset" type="number" placeholder="np. 30">
        <div class="btn-row" style="margin-top:8px">
          <button id="applyManual" class="btn btn-save">ZASTOSUJ OFFSET</button>
          <button id="resetOffset" class="btn btn-ghost">RESET</button>
        </div>
      </div>
    </div>
  </div>
  <div id="trainOverlay" class="overlay">
    <div class="modal">
      <button class="close-fab" id="closeTrain">X</button>
      <h3 class="center">üéß Tryb treningowy</h3>
      <div class="block">
        <span class="label">Wybierz sygna≈Ç</span>
        <select id="trainSelect">
          <option value="gold">Z≈Çoto (2450 Hz)</option>
          <option value="silver">Srebro (2800 Hz)</option>
          <option value="iron">≈ªelazo (420 Hz)</option>
          <option value="foil">Folia (850 Hz)</option>
          <option value="deep">G≈Çƒôboki (600 Hz, d≈Çugi)</option>
        </select>
      </div>
      <div class="btn-row">
        <button id="playTrain" class="btn btn-start">‚ñ∂ ODTW√ìRZ</button>
      </div>
    </div>
  </div>
  <div id="toast" class="toast">OK</div>

  <script>
    /* ========= HELPERS ========= */
    Math.clip = (val, min, max) => Math.min(Math.max(val, min), max);
    function median(arr){
      if(arr.length===0) return 0;
      const s=[...arr].sort((a,b)=>a-b);
      const mid=Math.floor(s.length/2);
      return s.length%2 ? s[mid] : (s[mid-1]+s[mid])/2;
    }
    function toastMsg(msg, t=1500){
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toast.style.display = 'none', t);
    }

    /* ========= DOM ========= */
    const $ = id => document.getElementById(id);
    const statusEl = $('status'), micSelect=$('micSelect');
    const sensitivity=$('sensitivity'), marginVal=$('marginVal'), noiseVal=$('noiseVal'), thVal=$('thVal');
    const freqEl=$('freqValue'), volEl=$('volValue'), timeEl=$('timeValue'), aiMsg=$('aiMsg'), confidenceBar=$('confidenceBar');
    const startBtn=$('startBtn'), stopBtn=$('stopBtn'), saveBtn=$('saveBtn');
    const spectrum=$('spectrumCanvas'); const sctx = spectrum.getContext('2d');
    const detCard=$('detCard'), detList=$('detList'), searchInput=$('searchInput');
    const calibBadge=$('calibBadge');
    const saveOverlay=$('saveOverlay'), noteInput=$('noteInput');
    const confirmSave=$('confirmSave'), cancelSave=$('cancelSave'), discardBtn=$('discardBtn');
    const calibOverlay=$('calibOverlay'), calibRef=$('calibRef'), liveCalib=$('liveCalib');
    const calibMsg=$('calibMsg'), autoBtn=$('autoBtn'), grabBtn=$('grabBtn'), quickBtn=$('quickBtn');
    const applyBtn=$('applyBtn'), clearSamplesBtn=$('clearSamplesBtn'), samplesCard=$('samplesCard'), samplesList=$('samplesList'), sampleCount=$('sampleCount');
    const manualOffset=$('manualOffset'), applyManual=$('applyManual'), resetOffset=$('resetOffset'), closeCalib=$('closeCalib');
    const trainBtn=$('trainBtn'), trainOverlay=$('trainOverlay'), closeTrain=$('closeTrain'), trainSelect=$('trainSelect'), playTrain=$('playTrain');
    const mapBtn=$('mapBtn'), recordBtn=$('recordBtn'), exportBtn=$('exportBtn');
    const ttsToggle=$('ttsToggle'), autoSaveToggle=$('autoSaveToggle'), hudToggle=$('hudToggle'), cloudBtn=$('cloudBtn');
    const toast=$('toast');
    const calibMicBtn = $('calibMicBtn');
    const sampleNameInput = $('sampleNameInput'), sampleTypeInput = $('sampleTypeInput'), saveSampleBtn = $('saveSampleBtn');
    const savedSamplesList = $('savedSamplesList'), editSampleBtn = $('editSampleBtn'), useSampleAsRef = $('useSampleAsRef'), deleteSampleBtn = $('deleteSampleBtn');
    const freqRangeInput = $('freqRange'), minDurInput = $('minDur'), maxDurInput = $('maxDur');

    /* ========= STATE ========= */
    let audioCtx=null, analyser=null, mediaStream=null, srcNode=null;
    let isListening=false, signalStart=null;
    let detections=[];
    let selectedMic = localStorage.getItem('ndx_mic') || '';
    let marginDb = parseInt(localStorage.getItem('ndx_margin') || '6', 10);
    let frequencyOffset = parseFloat(localStorage.getItem('ndx_offset') || '0');
    let ttsEnabled = localStorage.getItem('ndx_tts') === 'true';
    let autoSaveEnabled = localStorage.getItem('ndx_autosave') === 'true';
    let hudMode = false;
    let noiseRms = 0.01; const noiseAlpha = 0.98;
    let emaFreq=null, emaVol=null; const emaBeta=0.85;
    let recentFreqs=[]; const RECENT_MAX=12;
    let lastDet = null;
    let db=null; const DB_NAME='NeuroDetFusionDB', DB_VER=1;
    let samples = [];
    let autoCapturing = false, autoBuf=[], autoStart=0, autoSilence=0;
    let mediaRecorder=null, recChunks=[];
    let calibAudioCtx = null, calibAnalyser = null, calibStream = null;
    let isCalibMicActive = false;
    let savedSamples = JSON.parse(localStorage.getItem('ndx_saved_samples') || '[]');
    let selectedSampleIndex = -1;

    /* ========= UTILS ========= */
    async function populateMics(){
      try{
        const devs = await navigator.mediaDevices.enumerateDevices();
        const mics = devs.filter(d=>d.kind==='audioinput');
        micSelect.innerHTML = mics.length ? mics.map(d=>`<option value="${d.deviceId}">${d.label||('Mikrofon '+d.deviceId.slice(0,6))}</option>`).join('') : '<option value="">Domy≈õlny</option>';
        if (selectedMic && [...micSelect.options].some(o=>o.value===selectedMic)) micSelect.value=selectedMic;
      }catch(e){}
    }
    function speak(text) {
      if (ttsEnabled && 'speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'pl-PL';
        utterance.rate = 0.9;
        utterance.pitch = 1.2;
        speechSynthesis.speak(utterance);
      }
    }
    function refinedFreqInWindow(byteMag, centerIndex, windowSize, sr, fftSize) {
      const start = Math.max(0, centerIndex - windowSize);
      const end = Math.min(byteMag.length - 1, centerIndex + windowSize);
      let p = start, pv = byteMag[start];
      for (let i = start + 1; i <= end; i++) {
        if (byteMag[i] > pv) { pv = byteMag[i]; p = i; }
      }
      if (p <= 0 || p >= byteMag.length - 1) return (p * sr) / fftSize;
      const a = byteMag[p-1], b = byteMag[p], c = byteMag[p+1];
      const d = a - 2*b + c;
      const pAdj = d ? 0.5 * (a - c) / d : 0;
      return ((p + pAdj) * sr) / fftSize;
    }
    function drawSpectrum(data){
      const sctx = spectrum.getContext('2d');
      sctx.clearRect(0,0,spectrum.width,spectrum.height);
      const bw = spectrum.width/data.length;
      for(let i=0;i<data.length;i++){
        const h = (data[i]/255)*spectrum.height;
        const hue=(i/data.length)*360;
        sctx.fillStyle=`hsl(${hue},100%,50%)`;
        sctx.fillRect(i*bw, spectrum.height-h, bw, h);
      }
    }
    function aiClassify(freq, dur, vol) {
      const minDur = parseFloat(minDurInput?.value || '0.02');
      const maxDur = parseFloat(maxDurInput?.value || '0.80');
      if (dur < minDur || dur > maxDur) {
        return { type: "‚è≥ Czas poza zakresem", confidence: 0.1 };
      }
      const corr = freq + frequencyOffset;
      for (const s of savedSamples) {
        if (!s.type || !s.freq || !s.std) continue;
        const diff = Math.abs(corr - s.freq);
        if (diff <= 2 * s.std) {
          const conf = Math.clip(0.7 + 0.3 * (1 - diff / (2 * s.std)), 0.5, 1.0);
          return { type: s.type, confidence: conf };
        }
      }
      if (corr > 2200 && dur > 0.2 && dur < maxDur) return { type: "üí∞ Z≈ÅOTO/SREBRO", confidence: 0.92 };
      if (corr > 700 && corr < 1000 && dur < 0.4) return { type: "ü™ô FOLIA/PIENIƒÑDZ", confidence: 0.85 };
      if (corr < 600 && dur < 0.3) return { type: "üî© ≈ªELAZO", confidence: 0.88 };
      if (corr > 1000 && corr < 2000 && dur > 0.8) return { type: "üè∫ G≈ÅƒòBOKI CEL", confidence: 0.76 };
      return { type: "‚ùì NIEZNANY", confidence: 0.5 };
    }
    async function startMic(){
      try{
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ alert("Brak mikrofonu. U≈ºyj HTTPS/localhost."); return; }
        if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if (audioCtx.state==='suspended') await audioCtx.resume();
        if (mediaStream) { mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
        const base = {echoCancellation:false, noiseSuppression:false, autoGainControl:false};
        const cons = micSelect.value ? { audio:{deviceId:{exact:micSelect.value}, ...base} } : { audio:base };
        mediaStream = await navigator.mediaDevices.getUserMedia(cons);
        srcNode = audioCtx.createMediaStreamSource(mediaStream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize=2048; analyser.smoothingTimeConstant=0.8;
        srcNode.connect(analyser);
        isListening=true;
        startBtn.disabled=true; stopBtn.disabled=false;
        statusEl.textContent="üéôÔ∏è S≈ÅUCHAM..."; statusEl.parentElement.classList.add('pulse');
        animate();
      }catch(e){alert("B≈ÇƒÖd mikrofonu");}
    }
    function stopMic(){
      isListening=false;
      if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
      if (audioCtx && audioCtx.state!=='closed'){ audioCtx.close(); audioCtx=null; }
      startBtn.disabled=false; stopBtn.disabled=true;
      statusEl.textContent="Zatrzymano"; statusEl.parentElement.classList.remove('pulse');
      freqEl.textContent="---"; volEl.textContent="---"; timeEl.textContent="---";
      aiMsg.textContent="üëÇ Czekam na sygna≈Ç...";
      saveBtn.disabled=true; lastDet=null; emaFreq=null; emaVol=null;
    }
    function animate(){
      if (!isListening || !analyser) return;
      requestAnimationFrame(animate);
      const N=analyser.frequencyBinCount;
      const fdata=new Uint8Array(N); analyser.getByteFrequencyData(fdata);
      let p=0,pv=0; for(let i=0;i<N;i++){ if(fdata[i]>pv){pv=fdata[i]; p=i;} }
      const rangeHz = parseFloat(freqRangeInput?.value || '10');
      const binWidth = audioCtx.sampleRate / analyser.fftSize;
      const windowBins = Math.max(1, Math.round(rangeHz / binWidth));
      const freq = refinedFreqInWindow(fdata, p, windowBins, audioCtx.sampleRate, analyser.fftSize);
      const tdata = new Float32Array(analyser.fftSize); analyser.getFloatTimeDomainData(tdata);
      let s=0; for(let i=0;i<tdata.length;i++) s+=tdata[i]*tdata[i];
      const rms = Math.sqrt(s/tdata.length);
      const db = 20*Math.log10(rms||1e-6);
      const noiseDb = 20*Math.log10(noiseRms||1e-6);
      const thr = noiseDb + marginDb;
      const isSig = db > thr;
      if(!isSig) noiseRms = noiseAlpha*noiseRms + (1-noiseAlpha)*rms;
      noiseVal.textContent=noiseDb.toFixed(1); thVal.textContent=thr.toFixed(1);
      recentFreqs.push(freq); if(recentFreqs.length>RECENT_MAX) recentFreqs.shift();
      if (autoCapturing && isListening && !isCalibMicActive){
        if (autoBuf.length===0 && isSig){
          autoStart = performance.now(); autoBuf=[freq]; autoSilence=0;
          calibMsg.textContent="‚è∫Ô∏è Rejestrowanie pr√≥bki...";
        } else if (autoBuf.length>0){
          if (isSig) autoBuf.push(freq); else autoSilence++;
          const dur=(performance.now()-autoStart)/1000;
          if ((dur>=0.12 && autoSilence>=6) || dur>=1.8){
            if (autoBuf.length>=5){
              const med = Math.round(median(autoBuf));
              samples.push(med); renderSamples(); calibUpdateCounter();
              calibMsg.innerHTML=`‚úÖ Dodano pr√≥bkƒô: ${med} Hz`;
            } else calibMsg.innerHTML='‚ùå Za ma≈Ço danych.';
            autoCapturing=false; autoBuf=[]; autoSilence=0;
          }
        }
      }
      const now=performance.now();
      if(isSig && !signalStart){
        signalStart=now;
        const aiRes = aiClassify(freq, 0, db);
        aiMsg.innerHTML = `üéôÔ∏è Wykryto: <b>${aiRes.type}</b>`;
        aiMsg.classList.toggle('ai-high-confidence', aiRes.confidence > 0.85);
        confidenceBar.style.width = `${aiRes.confidence * 100}%`;
        if (aiRes.confidence > 0.85 && ttsEnabled) speak(`Wykryto: ${aiRes.type}`);
      }
      if(!isSig && signalStart){
        const dur=((now-signalStart)/1000).toFixed(2);
        const corr=freq+frequencyOffset;
        const aiRes = aiClassify(corr, parseFloat(dur), db);
        aiMsg.innerHTML = `‚úÖ Zako≈Ñczono: <b>${aiRes.type}</b> (${dur}s)`;
        aiMsg.classList.toggle('ai-high-confidence', aiRes.confidence > 0.85);
        confidenceBar.style.width = `${aiRes.confidence * 100}%`;
        lastDet={freq:corr, volume:db, duration:parseFloat(dur), date:new Date().toISOString(), confidence:aiRes.confidence, type: aiRes.type};
        signalStart=null;
        if (autoSaveEnabled) {
          setTimeout(() => { if (db) dbAdd(lastDet).then(() => loadDetections()); }, 100);
        } else saveBtn.disabled=false;
      }
      if(signalStart) timeEl.textContent=((now-signalStart)/1000).toFixed(2);
      const corr=freq+frequencyOffset;
      emaFreq = (emaFreq==null)?corr:(emaBeta*emaFreq+(1-emaBeta)*corr);
      emaVol  = (emaVol==null)?db:(emaBeta*emaVol +(1-emaBeta)*db);
      freqEl.textContent=(emaFreq||corr).toFixed(0);
      volEl.textContent=(emaVol||db).toFixed(1);
      drawSpectrum(fdata);
    }
    async function startCalibMic() {
      try {
        if (!calibAudioCtx) calibAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (calibAudioCtx.state === 'suspended') await calibAudioCtx.resume();
        if (calibStream) calibStream.getTracks().forEach(t => t.stop());
        const base = {echoCancellation:false, noiseSuppression:false, autoGainControl:false};
        const cons = micSelect.value ? { audio:{deviceId:{exact:micSelect.value}, ...base} } : { audio:base };
        calibStream = await navigator.mediaDevices.getUserMedia(cons);
        const src = calibAudioCtx.createMediaStreamSource(calibStream);
        calibAnalyser = calibAudioCtx.createAnalyser();
        calibAnalyser.fftSize = 2048;
        calibAnalyser.smoothingTimeConstant = 0.8;
        src.connect(calibAnalyser);
        isCalibMicActive = true;
        calibMicBtn.textContent = "üé§ MIC KALIBRACJI: W≈Å";
        calibMicBtn.style.background = "#228822";
        calibAnimate();
      } catch (e) {
        toastMsg("B≈ÇƒÖd mikrofonu");
        calibMicBtn.textContent = "üé§ MIC KALIBRACJI: WY≈Å";
        calibMicBtn.style.background = "";
      }
    }
    function stopCalibMic() {
      isCalibMicActive = false;
      if (calibStream) { calibStream.getTracks().forEach(t => t.stop()); calibStream = null; }
      if (calibAudioCtx) { calibAudioCtx.close(); calibAudioCtx = null; }
      calibMicBtn.textContent = "üé§ MIC KALIBRACJI: WY≈Å";
      calibMicBtn.style.background = "";
      liveCalib.textContent = "---";
    }
    function calibAnimate() {
      if (!isCalibMicActive || !calibAnalyser) return;
      requestAnimationFrame(calibAnimate);
      const N = calibAnalyser.frequencyBinCount;
      const fdata = new Uint8Array(N);
      calibAnalyser.getByteFrequencyData(fdata);
      let p = 0, pv = 0;
      for (let i = 0; i < N; i++) if (fdata[i] > pv) { pv = fdata[i]; p = i; }
      const rangeHz = parseFloat(freqRangeInput?.value || '10');
      const binWidth = calibAudioCtx.sampleRate / calibAnalyser.fftSize;
      const windowBins = Math.max(1, Math.round(rangeHz / binWidth));
      const freq = refinedFreqInWindow(fdata, p, windowBins, calibAudioCtx.sampleRate, calibAnalyser.fftSize);
      liveCalib.textContent = Math.round(freq);
      recentFreqs.push(freq);
      if (recentFreqs.length > RECENT_MAX) recentFreqs.shift();
      if (autoCapturing && isCalibMicActive){
        if (autoBuf.length === 0 && freq > 100 && freq < 5000){
          autoStart = performance.now(); autoBuf = [freq]; autoSilence = 0;
          calibMsg.textContent="‚è∫Ô∏è Rejestrowanie pr√≥bki...";
        } else if (autoBuf.length > 0){
          if (freq > 100 && freq < 5000) { autoBuf.push(freq); autoSilence = 0; }
          else autoSilence++;
          const dur=(performance.now() - autoStart)/1000;
          if ((dur >= 0.12 && autoSilence >= 6) || dur >= 1.8){
            if (autoBuf.length >= 5){
              const med = Math.round(median(autoBuf));
              samples.push(med); renderSamples(); calibUpdateCounter();
              calibMsg.innerHTML=`‚úÖ Dodano pr√≥bkƒô: ${med} Hz`;
            } else calibMsg.innerHTML='‚ùå Za ma≈Ço danych.';
            autoCapturing = false; autoBuf = []; autoSilence = 0;
          }
        }
      }
    }
    function renderSamples(){
      if (samples.length === 0) { samplesCard.style.display = 'none'; return; }
      samplesCard.style.display = 'block';
      samplesList.innerHTML = samples.map((v, i) => 
        `<div class="item">
          <div>Pr√≥bka ${i+1}: <b>${v} Hz</b></div>
          <button class="btn btn-danger btn-sm" style="padding:4px 8px;font-size:0.8rem;" data-idx="${i}">üóëÔ∏è</button>
        </div>`
      ).join('');
      samplesList.querySelectorAll('[data-idx]').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx, 10);
          samples.splice(idx, 1);
          renderSamples();
          calibUpdateCounter();
          toastMsg(`üóëÔ∏è Usuniƒôto pr√≥bkƒô ${idx+1}`);
        });
      });
    }
    function calibUpdateCounter(){ sampleCount.textContent = `${samples.length} / 5`; }
    function renderSavedSamples() {
      savedSamplesList.innerHTML = savedSamples.length 
        ? savedSamples.map((s,i) => `<div class="item${i===selectedSampleIndex?' selected':''}" onclick="selectSample(${i})">
            <b>${s.name || 'Brak nazwy'}</b> <span style="color:#ffd93d">${s.type || '‚ùì'}</span><br>
            <small>${Math.round(s.freq)} Hz ¬± ${s.std.toFixed(1)}</small>
          </div>`).join('')
        : `<div class="item center">Brak zapisanych wzorc√≥w</div>`;
      const hasSel = selectedSampleIndex >= 0;
      editSampleBtn.disabled = useSampleAsRef.disabled = deleteSampleBtn.disabled = !hasSel;
    }
    window.selectSample = i => { selectedSampleIndex = i; renderSavedSamples(); };
    saveSampleBtn.onclick = () => {
      const name = sampleNameInput.value.trim();
      const type = sampleTypeInput.value.trim();
      if (!name || !type) return toastMsg("Wpisz nazwƒô i typ!");
      if (recentFreqs.length < 5) return toastMsg("Zbierz min. 5 odczyt√≥w");
      const f = [...recentFreqs];
      const mean = f.reduce((a,b)=>a+b,0)/f.length;
      const std = Math.sqrt(f.reduce((sum,x) => sum + (x-mean)**2, 0) / f.length);
      savedSamples.push({name, type, freq: mean, std});
      localStorage.setItem('ndx_saved_samples', JSON.stringify(savedSamples));
      renderSavedSamples(); 
      selectedSampleIndex = -1;
      sampleNameInput.value = ''; sampleTypeInput.value = '';
      toastMsg(`‚úÖ Zapisano: ${name} ‚Üí ${type}`);
    };
    editSampleBtn.onclick = () => {
      if (selectedSampleIndex < 0) return;
      const s = savedSamples[selectedSampleIndex];
      sampleNameInput.value = s.name || '';
      sampleTypeInput.value = s.type || '';
      toastMsg(`‚úèÔ∏è Edytujesz: ${s.name}`);
    };
    deleteSampleBtn.onclick = () => {
      if (selectedSampleIndex < 0) return;
      if (!confirm(`UsunƒÖƒá wzorzec "${savedSamples[selectedSampleIndex].name}"?`)) return;
      savedSamples.splice(selectedSampleIndex, 1);
      localStorage.setItem('ndx_saved_samples', JSON.stringify(savedSamples));
      selectedSampleIndex = -1;
      renderSavedSamples();
      sampleNameInput.value = ''; sampleTypeInput.value = '';
      toastMsg("üóëÔ∏è Usuniƒôto");
    };
    useSampleAsRef.onclick = () => {
      if (selectedSampleIndex < 0) return;
      const s = savedSamples[selectedSampleIndex];
      frequencyOffset = s.freq - median(recentFreqs);
      localStorage.setItem('ndx_offset', String(frequencyOffset));
      updateCalibBadge();
      toastMsg(`‚úÖ U≈ºyto jako ref: ${s.name} (${s.type})`);
    };
    function doQuickCalib(){
      const med = Math.round(median(recentFreqs));
      if(!isFinite(med)||med<=0){ toastMsg('Brak stabilnej pr√≥bki'); return; }
      const ref = parseFloat(calibRef.value);
      frequencyOffset = ref - med;
      localStorage.setItem('ndx_offset', String(frequencyOffset));
      updateCalibBadge();
      calibMsg.textContent = `‚úÖ Szybka kalibracja: offset ${frequencyOffset>=0?'+':''}${frequencyOffset.toFixed(0)} Hz`;
    }
    function doApplyFromSamples(){
      if(samples.length<3){ toastMsg('Zbierz min. 3 pr√≥bki'); return; }
      const med=Math.round(median(samples)), ref=parseFloat(calibRef.value);
      frequencyOffset = ref - med;
      localStorage.setItem('ndx_offset', String(frequencyOffset));
      updateCalibBadge();
      calibMsg.textContent = `‚úÖ Zastosowano offset: ${frequencyOffset>=0?'+':''}${frequencyOffset.toFixed(0)} Hz`;
    }
    function updateCalibBadge(){
      if (Math.abs(frequencyOffset) > 0.5){
        calibBadge.style.display='block';
        calibBadge.textContent = `‚öôÔ∏è Offset: ${frequencyOffset>=0?'+':''}${frequencyOffset.toFixed(0)} Hz`;
      } else calibBadge.style.display='none';
    }

    /* ========= INDEXEDDB ========= */
    function dbOpen(){
      return new Promise((resolve,reject)=>{
        if(!('indexedDB' in window)) resolve(null);
        const req=indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded=e=>{
          const db=e.target.result;
          if(!db.objectStoreNames.contains('detections')) db.createObjectStore('detections',{keyPath:'id',autoIncrement:true});
        };
        req.onsuccess=()=>resolve(req.result);
        req.onerror=()=>reject(req.error);
      });
    }
    function dbAdd(item){
      return new Promise((resolve,reject)=>{
        const tx=db.transaction('detections','readwrite');
        tx.objectStore('detections').add(item);
        tx.oncomplete=()=>resolve(true);
        tx.onerror=()=>reject(tx.error);
      });
    }
    function dbAll(){
      return new Promise((resolve,reject)=>{
        const tx=db.transaction('detections','readonly');
        const req=tx.objectStore('detections').getAll();
        req.onsuccess=()=>resolve(req.result||[]);
        req.onerror=()=>reject(req.error);
      });
    }
    function dbDelete(id){
      if (typeof id === 'string' && id.startsWith('tmp_')) return Promise.resolve();
      return new Promise((resolve,reject)=>{
        const tx=db.transaction('detections','readwrite');
        tx.objectStore('detections').delete(id);
        tx.oncomplete=()=>resolve(true);
        tx.onerror=()=>reject(tx.error);
      });
    }
    function renderDetections(filter=""){
      if(!detections.length){detCard.style.display='none';return;}
      detCard.style.display='block'; detList.innerHTML='';
      const f=filter.trim().toLowerCase();
      const enriched = detections.map((d, idx) => ({
        ...d,
        id: d.id != null ? d.id : `tmp_${Date.now()}_${idx}`
      }));
      enriched
        .slice().reverse()
        .filter(d => (d.note || '').toLowerCase().includes(f))
        .forEach(d => {
          const conf = d.confidence ? ` | ${(d.confidence * 100).toFixed(0)}%` : '';
          const dateStr = d.date && d.date !== 'Invalid Date' 
            ? new Date(d.date).toLocaleString('pl-PL') 
            : 'Invalid Date';
          const freqStr = isFinite(d.freq) ? Math.round(d.freq) : 'NaN';
          const durStr = d.duration && isFinite(d.duration) ? d.duration.toFixed(2) : '---';
          const el = document.createElement('div');
          el.className = 'item';
          el.innerHTML = `
            <div>
              <b>${d.note || '‚ùì NIEZNANY'}</b><br>
              <small>${dateStr} | ${freqStr} Hz | ${durStr}s${conf}</small>
            </div>
            <div class="item-actions">
              <button class="btn btn-ghost btn-sm" data-id="${d.id}" style="padding:4px 8px;font-size:0.8rem;">üóëÔ∏è</button>
            </div>
          `;
          detList.appendChild(el);
        });
      detList.querySelectorAll('[data-id]').forEach(btn => {
        btn.addEventListener('click', async e => {
          const id = e.currentTarget.dataset.id;
          if (confirm(`UsunƒÖƒá ten wpis? (${id.startsWith('tmp_')?'tymczasowy':'trwa≈Çy'})`)) {
            if (id.startsWith('tmp_')) {
              detections = detections.filter((_, idx) => {
                const actualId = detections[idx].id != null ? detections[idx].id : `tmp_${Date.now()}_${idx}`;
                return actualId !== id;
              });
              renderDetections();
            } else {
              await dbDelete(parseInt(id, 10));
              await loadDetections();
            }
            toastMsg('üóëÔ∏è Usuniƒôto');
          }
        });
      });
    }

    /* ========= EVENTS ‚Äî ‚úÖ ULEPSZONE ZAPISYWANIE ========= */
    startBtn.addEventListener('click', startMic);
    stopBtn.addEventListener('click', stopMic);
    saveBtn.addEventListener('click', ()=>{
      if (!lastDet) {
        const med = median(recentFreqs) + frequencyOffset;
        if (!isFinite(med) || med <= 0) { alert('Brak danych.'); return; }
        const dStr = prompt('Czas sygna≈Çu [s]', '0.4');
        if (dStr === null) return;
        const aiRes = aiClassify(med, parseFloat(dStr), -30);
        lastDet = {
          freq: med,
          volume: emaVol ?? -40,
          duration: Math.max(0.05, parseFloat(dStr) || 0.4),
          date: new Date().toISOString(),
          confidence: aiRes.confidence,
          type: aiRes.type || '‚ùì NIEZNANY'
        };
      }
      saveOverlay.style.display = 'flex';
      noteInput.value = lastDet.type || '‚ùì NIEZNANY';
      noteInput.focus();
      // ‚úÖ Aktywacja tag√≥w przy otwarciu
      document.querySelectorAll('#saveOverlay [data-tag]').forEach(btn => {
        btn.onclick = () => {
          const current = noteInput.value;
          const tag = btn.dataset.tag;
          noteInput.value = current ? `${current} ${tag}` : tag;
          noteInput.focus();
        };
      });
    });
    openCalib.addEventListener('click', ()=>{
      calibOverlay.style.display='flex';
      renderSamples(); updateCalibBadge(); renderSavedSamples();
    });
    closeCalib.addEventListener('click', ()=>{
      calibOverlay.style.display='none';
      if(isCalibMicActive) stopCalibMic();
    });
    calibMicBtn.addEventListener('click', () => isCalibMicActive ? stopCalibMic() : startCalibMic());
    autoBtn.addEventListener('click', ()=>{
      if (!isListening && !isCalibMicActive){ toastMsg('W≈ÇƒÖcz mikrofon'); return; }
      autoCapturing=true; calibMsg.textContent='üéôÔ∏è Czekam na sygna≈Ç...';
    });
    grabBtn.addEventListener('click', ()=>{
      if (!isListening && !isCalibMicActive){ toastMsg('W≈ÇƒÖcz mikrofon'); return; }
      const med=Math.round(median(recentFreqs)); if(!isFinite(med)||med<=0){ toastMsg('Brak pr√≥bki'); return; }
      samples.push(med); renderSamples(); calibMsg.textContent=`‚úÖ Dodano: ${med} Hz`;
    });
    quickBtn.addEventListener('click', doQuickCalib);
    applyBtn.addEventListener('click', doApplyFromSamples);
    clearSamplesBtn.addEventListener('click', ()=>{ samples=[]; renderSamples(); calibMsg.textContent='Pr√≥bki wyczyszczone'; });
    applyManual.addEventListener('click', ()=>{
      const v=parseFloat(manualOffset.value); if(isNaN(v)) return;
      frequencyOffset=v; localStorage.setItem('ndx_offset', String(v)); updateCalibBadge(); calibMsg.textContent=`‚úÖ Offset: ${v>=0?'+':''}${v.toFixed(0)} Hz`;
    });
    resetOffset.addEventListener('click', ()=>{ frequencyOffset=0; localStorage.setItem('ndx_offset','0'); updateCalibBadge(); calibMsg.textContent='Offset zresetowany'; });
    sensitivity.value=marginDb; marginVal.textContent=marginDb;
    sensitivity.addEventListener('input', ()=>{
      marginDb = parseInt(sensitivity.value,10);
      marginVal.textContent=marginDb;
      localStorage.setItem('ndx_margin', String(marginDb));
    });
    trainBtn.addEventListener('click', ()=> trainOverlay.style.display='flex');
    closeTrain.addEventListener('click', ()=> trainOverlay.style.display='none');
    playTrain.addEventListener('click', ()=>{
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const osc=ctx.createOscillator(), gain=ctx.createGain();
      const sel={gold:{f:2450,d:0.3},silver:{f:2800,d:0.4},iron:{f:420,d:0.2},foil:{f:850,d:0.15},deep:{f:600,d:0.8}}[trainSelect.value];
      osc.type='sine'; osc.frequency.value=sel.f; gain.gain.value=0.2;
      osc.connect(gain).connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime+sel.d);
    });
    mapBtn.addEventListener('click', () => { toastMsg("üó∫Ô∏è Mapa wy≈ÇƒÖczona ‚Äî brak GPS"); });
    recordBtn.addEventListener('click', ()=>{
      if (!mediaStream){ alert('Najpierw uruchom mikrofon.'); return; }
      try{
        const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' :
                     MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' :
                     MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
        mediaRecorder = new MediaRecorder(mediaStream, mime?{mimeType:mime}:undefined);
        recChunks=[];
        mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) recChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{
          const blob=new Blob(recChunks, {type: mime || 'audio/webm'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download=`NeuroDet_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.${mime.includes('mp4')?'mp4':'webm'}`; a.click();
          URL.revokeObjectURL(url); 
          toastMsg('‚úÖ Nagranie pobrane');
          recordBtn.textContent='üé§ NAGRAJ';
        };
        mediaRecorder.start();
        recordBtn.textContent='‚èπ ZATRZYMAJ';
      }catch(e){ alert('B≈ÇƒÖd nagrywania'); }
    });
    exportBtn.addEventListener('click', () => {
      let csv = "Data,Ton[Hz],Czas[s],Pewno≈õƒá,Opis\n";
      detections.forEach(d => {
        csv += `"${d.date}",${d.freq},${d.duration},${d.confidence || 0.5},"${d.note.replace(/"/g,'""')}"\n`;
      });
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `NeuroDet_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toastMsg('‚úÖ CSV gotowe');
    });
    ttsToggle.addEventListener('click', () => {
      ttsEnabled = !ttsEnabled;
      localStorage.setItem('ndx_tts', String(ttsEnabled));
      ttsToggle.textContent = `üîà TTS: ${ttsEnabled ? 'W≈Å' : 'WY≈Å'}`;
      if (ttsEnabled) speak("TTS w≈ÇƒÖczone");
    });
    autoSaveToggle.addEventListener('click', () => {
      autoSaveEnabled = !autoSaveEnabled;
      localStorage.setItem('ndx_autosave', String(autoSaveEnabled));
      autoSaveToggle.textContent = `üíæ AutoSave: ${autoSaveEnabled ? 'W≈Å' : 'WY≈Å'}`;
      toastMsg(autoSaveEnabled ? "AutoZapis W≈ÅƒÑCZONY" : "AutoZapis WY≈ÅƒÑCZONY");
    });
    hudToggle.addEventListener('click', () => {
      hudMode = !hudMode;
      document.body.classList.toggle('hud-mode', hudMode);
      hudToggle.textContent = `‚õ∂ HUD: ${hudMode ? 'W≈Å' : 'WY≈Å'}`;
    });
    cloudBtn.addEventListener('click', () => {
      toastMsg("‚òÅÔ∏è Backup ‚Üí CSV...");
      setTimeout(() => { exportBtn.click(); }, 300);
    });
    searchInput.addEventListener('input', () => renderDetections(searchInput.value));

    /* ========= INIT ========= */
    (async function init(){
      await populateMics();
      db = await dbOpen();
      if(db) detections = await dbAll();
      renderDetections();
      if (Math.abs(frequencyOffset) > 0.5) updateCalibBadge();
      ttsToggle.textContent = `üîà TTS: ${ttsEnabled ? 'W≈Å' : 'WY≈Å'}`;
      autoSaveToggle.textContent = `üíæ AutoSave: ${autoSaveEnabled ? 'W≈Å' : 'WY≈Å'}`;
      renderSavedSamples();

      // ‚úÖ Rejestracja Service Workera ‚Äî pe≈Çna funkcjonalno≈õƒá offline
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('‚úÖ SW registered:', reg.scope))
            .catch(err => console.warn('‚ö†Ô∏è SW failed:', err));
        });
      }
    })();
  </script>
</body>
</html>